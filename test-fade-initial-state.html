<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fade Initial State Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
        }
        .control-group {
            margin-bottom: 10px;
        }
        label {
            display: inline-block;
            width: 150px;
            margin-right: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        canvas {
            border: 2px solid #333;
            background-color: #000;
        }
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .test-results {
            margin-top: 20px;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
        }
        .test-step {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #333;
            border-radius: 4px;
        }
        .pass { color: #4CAF50; }
        .fail { color: #f44336; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fade Initial State Test</h1>
        <p>This test verifies that inactive cells do not become lit and then fade back to black when the simulation is first started after loading the page or after clicking the Reset button.</p>
        
        <div class="controls">
            <div class="control-group">
                <label for="simulationType">Simulation:</label>
                <select id="simulationType">
                    <option value="conway">Conway's Game of Life</option>
                    <option value="termite">Termite Algorithm</option>
                    <option value="ant">Langton's Ant</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="fadeCycles">Fade Cycles:</label>
                <input type="range" id="fadeCycles" min="1" max="10" value="5">
                <span id="fadeCyclesValue">5</span>
            </div>
            
            <div class="control-group">
                <label for="speed">Speed:</label>
                <input type="range" id="speed" min="1" max="10" value="1">
                <span id="speedValue">1 step/sec</span>
            </div>
            
            <div class="control-group">
                <button id="startBtn">Start</button>
                <button id="pauseBtn" disabled>Pause</button>
                <button id="resetBtn">Reset</button>
                <button id="clearBtn">Clear</button>
                <button id="runTestBtn">Run Test</button>
            </div>
        </div>
        
        <canvas id="canvas" width="600" height="400"></canvas>
        
        <div class="debug-info" id="debugInfo">
            Debug information will appear here...
        </div>
        
        <div class="test-results" id="testResults">
            <h3>Test Results</h3>
            <div id="testSteps"></div>
        </div>
    </div>

    <script src="simulations.js"></script>
    <script>
        let simulation;
        let debugInfo = document.getElementById('debugInfo');
        let testSteps = document.getElementById('testSteps');
        
        // Initialize simulation
        function initSimulation() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const type = document.getElementById('simulationType').value;
            
            simulation = SimulationFactory.createSimulation(type, canvas, ctx);
            simulation.setFadeOutCycles(parseInt(document.getElementById('fadeCycles').value));
            simulation.setSpeed(parseInt(document.getElementById('speed').value));
            simulation.init();
            
            logDebug(`Initialized ${type} simulation with fade cycles: ${simulation.getFadeOutCycles()}`);
        }
        
        // Event handlers
        document.getElementById('simulationType').addEventListener('change', () => {
            if (simulation) {
                simulation.pause();
                initSimulation();
            }
        });
        
        document.getElementById('fadeCycles').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('fadeCyclesValue').textContent = value;
            if (simulation) {
                simulation.setFadeOutCycles(parseInt(value));
            }
        });
        
        document.getElementById('speed').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('speedValue').textContent = value + ' step/sec';
            if (simulation) {
                simulation.setSpeed(parseInt(value));
            }
        });
        
        document.getElementById('startBtn').addEventListener('click', () => {
            if (simulation) {
                simulation.start();
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
                logDebug('Simulation started');
            }
        });
        
        document.getElementById('pauseBtn').addEventListener('click', () => {
            if (simulation) {
                simulation.pause();
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                logDebug('Simulation paused');
            }
        });
        
        document.getElementById('resetBtn').addEventListener('click', () => {
            if (simulation) {
                simulation.reset();
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                logDebug('Simulation reset');
            }
        });
        
        document.getElementById('clearBtn').addEventListener('click', () => {
            if (simulation) {
                simulation.clear();
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                logDebug('Simulation cleared');
            }
        });
        
        document.getElementById('runTestBtn').addEventListener('click', runTest);
        
        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.textContent += `[${timestamp}] ${message}\n`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        function addTestStep(message, type = 'info') {
            const step = document.createElement('div');
            step.className = `test-step ${type}`;
            step.textContent = message;
            testSteps.appendChild(step);
        }
        
        function clearTestSteps() {
            testSteps.innerHTML = '';
        }
        
        function runTest() {
            clearTestSteps();
            addTestStep('Starting fade initial state test...', 'info');
            
            // Test 1: Check initial state after page load
            addTestStep('Test 1: Checking initial state after page load', 'info');
            
            // Reset simulation to simulate fresh page load
            simulation.reset();
            simulation.pause();
            
            // Check fade states for a few inactive cells
            const testCells = [
                {row: 0, col: 0},
                {row: 1, col: 1},
                {row: 5, col: 5},
                {row: 10, col: 10}
            ];
            
            let allCellsBlack = true;
            testCells.forEach(({row, col}) => {
                const fadeFactor = simulation.getCellFadeFactor(row, col, false);
                const cellKey = `${row},${col}`;
                const fadeData = simulation.cellFadeStates.get(cellKey);
                
                addTestStep(`Cell [${row},${col}]: fadeFactor=${fadeFactor}, fadeData=${fadeData ? JSON.stringify(fadeData) : 'null'}`, 'info');
                
                if (fadeFactor !== 0) {
                    allCellsBlack = false;
                    addTestStep(`FAIL: Cell [${row},${col}] should be black (fadeFactor=0) but has fadeFactor=${fadeFactor}`, 'fail');
                }
            });
            
            if (allCellsBlack) {
                addTestStep('PASS: All inactive cells are properly black initially', 'pass');
            } else {
                addTestStep('FAIL: Some inactive cells are not black initially', 'fail');
            }
            
            // Test 2: Check state after starting simulation
            addTestStep('\nTest 2: Checking state after starting simulation', 'info');
            
            simulation.start();
            
            // Wait a moment for the first update
            setTimeout(() => {
                simulation.pause();
                
                let cellsStillBlack = true;
                testCells.forEach(({row, col}) => {
                    const fadeFactor = simulation.getCellFadeFactor(row, col, false);
                    const cellKey = `${row},${col}`;
                    const fadeData = simulation.cellFadeStates.get(cellKey);
                    
                    addTestStep(`Cell [${row},${col}]: fadeFactor=${fadeFactor}, fadeData=${fadeData ? JSON.stringify(fadeData) : 'null'}`, 'info');
                    
                    if (fadeData && fadeData.fadeCount > 0) {
                        cellsStillBlack = false;
                        addTestStep(`FAIL: Cell [${row},${col}] has fade data when it should remain black`, 'fail');
                    }
                });
                
                if (cellsStillBlack) {
                    addTestStep('PASS: Inactive cells remain black after starting simulation', 'pass');
                } else {
                    addTestStep('FAIL: Inactive cells have fade data after starting simulation', 'fail');
                }
                
                // Test 3: Check state after reset
                addTestStep('\nTest 3: Checking state after reset', 'info');
                
                simulation.reset();
                
                let resetCellsBlack = true;
                testCells.forEach(({row, col}) => {
                    const fadeFactor = simulation.getCellFadeFactor(row, col, false);
                    const cellKey = `${row},${col}`;
                    const fadeData = simulation.cellFadeStates.get(cellKey);
                    
                    addTestStep(`Cell [${row},${col}]: fadeFactor=${fadeFactor}, fadeData=${fadeData ? JSON.stringify(fadeData) : 'null'}`, 'info');
                    
                    if (fadeFactor !== 0) {
                        resetCellsBlack = false;
                        addTestStep(`FAIL: Cell [${row},${col}] should be black after reset but has fadeFactor=${fadeFactor}`, 'fail');
                    }
                });
                
                if (resetCellsBlack) {
                    addTestStep('PASS: All inactive cells are black after reset', 'pass');
                } else {
                    addTestStep('FAIL: Some inactive cells are not black after reset', 'fail');
                }
                
                addTestStep('\nTest completed!', 'info');
                
            }, 100);
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            initSimulation();
            logDebug('Page loaded, simulation initialized');
        });
    </script>
</body>
</html> 