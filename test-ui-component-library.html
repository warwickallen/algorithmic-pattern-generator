<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UI Component Library Test</title>
</head>
<body>
    <h1>UI Component Library Test</h1>
    <div id="test-results"></div>

    <script>
        // Copy the EventFramework class from app.js
        class EventFramework {
            constructor() {
                this.listeners = new Map();
                this.debouncedFunctions = new Map();
                this.throttledFunctions = new Map();
            }

            register(element, event, handler, options = {}) {
                const key = this.createListenerKey(element, event);
                this.listeners.set(key, handler);
                element.addEventListener(event, handler, options);
            }

            remove(element, event) {
                const key = this.createListenerKey(element, event);
                const handler = this.listeners.get(key);
                if (handler) {
                    element.removeEventListener(event, handler);
                    this.listeners.delete(key);
                }
            }

            removeAll(element) {
                const keys = Array.from(this.listeners.keys());
                keys.forEach(key => {
                    const [elementKey, event] = key.split('::');
                    if (elementKey === element) {
                        this.remove(element, event);
                    }
                });
            }

            cleanup() {
                this.listeners.clear();
                this.debouncedFunctions.clear();
                this.throttledFunctions.clear();
            }

            debounce(func, wait, key = null) {
                const funcKey = key || func.toString();
                if (this.debouncedFunctions.has(funcKey)) {
                    return this.debouncedFunctions.get(funcKey);
                }

                let timeout;
                const debounced = function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };

                this.debouncedFunctions.set(funcKey, debounced);
                return debounced;
            }

            throttle(func, limit, key = null) {
                const funcKey = key || func.toString();
                if (this.throttledFunctions.has(funcKey)) {
                    return this.throttledFunctions.get(funcKey);
                }

                let inThrottle;
                const throttled = function executedFunction(...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };

                this.throttledFunctions.set(funcKey, throttled);
                return throttled;
            }

            getElement(selector) {
                if (typeof selector === 'string') {
                    return document.querySelector(selector);
                }
                return selector;
            }

            createListenerKey(element, event) {
                return `${element}::${event}`;
            }

            registerBatch(registrations) {
                registrations.forEach(({ element, event, handler, options }) => {
                    this.register(element, event, handler, options);
                });
            }

            registerAllHandlers() {
                // Placeholder for compatibility
            }
        }

        // Copy the UIComponentLibrary class from app.js
        class UIComponentLibrary {
            constructor(eventFramework) {
                this.components = new Map();
                this.lifecycleHooks = new Map();
                this.componentTypes = new Set();
                this.defaultConfigs = new Map();
                this.eventFramework = eventFramework;
                this.initDefaultConfigs();
            }
            
            // Initialize default configurations for all component types
            initDefaultConfigs() {
                this.defaultConfigs.set('slider', {
                    min: 0,
                    max: 100,
                    step: 1,
                    value: 50,
                    format: (val) => val.toString(),
                    className: 'slider'
                });
                
                this.defaultConfigs.set('button', {
                    className: 'btn secondary',
                    disabled: false,
                    pressed: false
                });
                
                this.defaultConfigs.set('select', {
                    className: 'simulation-select',
                    placeholder: 'Select option...'
                });
                
                this.defaultConfigs.set('controlGroup', {
                    className: 'control-group',
                    layout: 'horizontal', // horizontal, vertical, grid
                    gap: '0.5rem',
                    visible: true
                });
                
                this.defaultConfigs.set('statusDisplay', {
                    className: 'status-info',
                    layout: 'horizontal',
                    gap: '0.5rem',
                    format: (value) => value.toString()
                });
                
                this.defaultConfigs.set('modal', {
                    className: 'modal',
                    backdrop: true,
                    closeOnEscape: true,
                    closeOnBackdrop: true,
                    animation: true
                });
                
                this.defaultConfigs.set('label', {
                    className: 'control-label',
                    required: false
                });
                
                this.defaultConfigs.set('container', {
                    className: 'ui-container',
                    layout: 'horizontal',
                    gap: '0.5rem',
                    visible: true
                });
            }
            
            // Create a standardized button component with enhanced features
            createButton(config) {
                const defaultConfig = this.defaultConfigs.get('button');
                const mergedConfig = { ...defaultConfig, ...config };
                
                const component = {
                    type: 'button',
                    id: mergedConfig.id,
                    element: document.getElementById(mergedConfig.id),
                    config: mergedConfig,
                    state: {
                        isEnabled: !mergedConfig.disabled,
                        isPressed: mergedConfig.pressed || false,
                        isVisible: true,
                        text: mergedConfig.label || mergedConfig.text || ''
                    },
                    methods: {
                        setText: (text) => this.setButtonText(component, text),
                        getText: () => this.getButtonText(component),
                        enable: () => this.enableComponent(component),
                        disable: () => this.disableComponent(component),
                        show: () => this.showComponent(component),
                        hide: () => this.hideComponent(component),
                        press: () => this.pressButton(component),
                        release: () => this.releaseButton(component),
                        toggle: () => this.toggleButton(component),
                        update: (newConfig) => this.updateButton(component, newConfig),
                        addEventListener: (event, handler) => this.addComponentEventListener(component, event, handler),
                        removeEventListener: (event) => this.removeComponentEventListener(component, event)
                    }
                };
                
                this.components.set(mergedConfig.id, component);
                this.componentTypes.add('button');
                this.initializeComponent(component);
                return component;
            }
            
            // Create a modal component
            createModal(config) {
                const defaultConfig = this.defaultConfigs.get('modal');
                const mergedConfig = { ...defaultConfig, ...config };
                
                const component = {
                    type: 'modal',
                    id: mergedConfig.id,
                    element: document.getElementById(mergedConfig.id),
                    config: mergedConfig,
                    state: {
                        isVisible: false,
                        isOpen: false,
                        title: mergedConfig.title || '',
                        content: mergedConfig.content || '',
                        backdrop: mergedConfig.backdrop,
                        closeOnEscape: mergedConfig.closeOnEscape,
                        closeOnBackdrop: mergedConfig.closeOnBackdrop,
                        animation: mergedConfig.animation
                    },
                    methods: {
                        open: () => this.openModal(component),
                        close: () => this.closeModal(component),
                        toggle: () => this.toggleModal(component),
                        setContent: (content) => this.setModalContent(component, content),
                        getContent: () => this.getModalContent(component),
                        setTitle: (title) => this.setModalTitle(component, title),
                        getTitle: () => this.getModalTitle(component),
                        update: (newConfig) => this.updateModal(component, newConfig),
                        addEventListener: (event, handler) => this.addComponentEventListener(component, event, handler),
                        removeEventListener: (event) => this.removeComponentEventListener(component, event)
                    }
                };
                
                this.components.set(mergedConfig.id, component);
                this.componentTypes.add('modal');
                this.initializeComponent(component);
                return component;
            }
            
            initializeComponent(component) {
                switch (component.type) {
                    case 'slider':
                        this.initializeSlider(component);
                        break;
                    case 'button':
                        this.initializeButton(component);
                        break;
                    case 'select':
                        this.initializeSelect(component);
                        break;
                    case 'controlGroup':
                        this.initializeControlGroup(component);
                        break;
                    case 'statusDisplay':
                        this.initializeStatusDisplay(component);
                        break;
                    case 'modal':
                        this.initializeModal(component);
                        break;
                    case 'label':
                        this.initializeLabel(component);
                        break;
                    case 'container':
                        this.initializeContainer(component);
                        break;
                }
                
                // Register lifecycle hooks
                this.registerLifecycleHooks(component);
                
                // Trigger onMount hook
                const hooks = this.lifecycleHooks.get(component.id);
                if (hooks && hooks.onMount) {
                    hooks.onMount();
                }
            }
            
            initializeButton(component) {
                if (component.element) {
                    component.element.textContent = component.state.text;
                    component.element.className = component.config.className;
                    component.element.disabled = !component.state.isEnabled;
                    
                    if (component.state.isPressed) {
                        component.element.classList.add('pressed');
                    }
                }
            }
            
            initializeModal(component) {
                if (component.element) {
                    component.element.className = component.config.className;
                    component.element.style.display = 'none';
                }
            }
            
            initializeSlider(component) {
                // Placeholder
            }
            
            initializeSelect(component) {
                // Placeholder
            }
            
            initializeControlGroup(component) {
                // Placeholder
            }
            
            initializeStatusDisplay(component) {
                // Placeholder
            }
            
            initializeLabel(component) {
                // Placeholder
            }
            
            initializeContainer(component) {
                // Placeholder
            }
            
            setButtonText(component, text) {
                if (component.element) {
                    component.state.text = text;
                    component.element.textContent = text;
                    this.triggerUpdateHook(component);
                }
            }
            
            getButtonText(component) {
                return component.state.text;
            }
            
            enableComponent(component) {
                if (component.element) {
                    component.state.isEnabled = true;
                    component.element.disabled = false;
                    this.triggerUpdateHook(component);
                }
            }
            
            disableComponent(component) {
                if (component.element) {
                    component.state.isEnabled = false;
                    component.element.disabled = true;
                    this.triggerUpdateHook(component);
                }
            }
            
            showComponent(component) {
                if (component.element) {
                    component.state.isVisible = true;
                    component.element.style.display = 'block';
                    this.triggerUpdateHook(component);
                }
            }
            
            hideComponent(component) {
                if (component.element) {
                    component.state.isVisible = false;
                    component.element.style.display = 'none';
                    this.triggerUpdateHook(component);
                }
            }
            
            pressButton(component) {
                if (component.element) {
                    component.state.isPressed = true;
                    component.element.classList.add('pressed');
                    this.triggerUpdateHook(component);
                }
            }
            
            releaseButton(component) {
                if (component.element) {
                    component.state.isPressed = false;
                    component.element.classList.remove('pressed');
                    this.triggerUpdateHook(component);
                }
            }
            
            toggleButton(component) {
                if (component.state.isPressed) {
                    this.releaseButton(component);
                } else {
                    this.pressButton(component);
                }
            }
            
            openModal(component) {
                if (component.element) {
                    component.state.isVisible = true;
                    component.state.isOpen = true;
                    component.element.style.display = 'block';
                    
                    if (component.state.backdrop) {
                        this.createModalBackdrop(component);
                    }
                    
                    if (component.state.closeOnEscape) {
                        this.setupModalEscapeHandler(component);
                    }
                    
                    this.triggerUpdateHook(component);
                }
            }
            
            closeModal(component) {
                if (component.element) {
                    component.state.isVisible = false;
                    component.state.isOpen = false;
                    component.element.style.display = 'none';
                    
                    this.removeModalBackdrop(component);
                    this.removeModalEscapeHandler(component);
                    
                    this.triggerUpdateHook(component);
                }
            }
            
            toggleModal(component) {
                if (component.state.isOpen) {
                    this.closeModal(component);
                } else {
                    this.openModal(component);
                }
            }
            
            setModalContent(component, content) {
                if (component.element) {
                    const contentElement = component.element.querySelector('[data-modal-content]');
                    if (contentElement) {
                        contentElement.innerHTML = content;
                    }
                }
            }
            
            getModalContent(component) {
                if (component.element) {
                    const contentElement = component.element.querySelector('[data-modal-content]');
                    return contentElement ? contentElement.innerHTML : '';
                }
                return '';
            }
            
            setModalTitle(component, title) {
                if (component.element) {
                    const titleElement = component.element.querySelector('[data-modal-title]');
                    if (titleElement) {
                        titleElement.textContent = title;
                    }
                }
            }
            
            getModalTitle(component) {
                if (component.element) {
                    const titleElement = component.element.querySelector('[data-modal-title]');
                    return titleElement ? titleElement.textContent : '';
                }
                return '';
            }
            
            updateButton(component, newConfig) {
                // Placeholder
            }
            
            updateModal(component, newConfig) {
                // Placeholder
            }
            
            addComponentEventListener(component, event, handler) {
                if (component.element) {
                    this.eventFramework.register(component.element, event, handler);
                }
            }
            
            removeComponentEventListener(component, event) {
                if (component.element) {
                    this.eventFramework.remove(component.element, event);
                }
            }
            
            registerLifecycleHooks(component) {
                const hooks = {
                    onMount: () => console.log(`Component ${component.id} mounted`),
                    onUnmount: () => console.log(`Component ${component.id} unmounted`),
                    onUpdate: () => console.log(`Component ${component.id} updated`),
                    onShow: () => console.log(`Component ${component.id} shown`),
                    onHide: () => console.log(`Component ${component.id} hidden`),
                    onEnable: () => console.log(`Component ${component.id} enabled`),
                    onDisable: () => console.log(`Component ${component.id} disabled`)
                };
                
                this.lifecycleHooks.set(component.id, hooks);
            }
            
            triggerUpdateHook(component) {
                const hooks = this.lifecycleHooks.get(component.id);
                if (hooks && hooks.onUpdate) {
                    hooks.onUpdate();
                }
            }
            
            createModalBackdrop(component) {
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop';
                backdrop.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 999;
                `;
                
                if (component.state.closeOnBackdrop) {
                    backdrop.addEventListener('click', () => this.closeModal(component));
                }
                
                document.body.appendChild(backdrop);
                component.backdropElement = backdrop;
            }
            
            removeModalBackdrop(component) {
                if (component.backdropElement) {
                    component.backdropElement.remove();
                    component.backdropElement = null;
                }
            }
            
            setupModalEscapeHandler(component) {
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        this.closeModal(component);
                    }
                };
                
                document.addEventListener('keydown', escapeHandler);
                component.escapeHandler = escapeHandler;
            }
            
            removeModalEscapeHandler(component) {
                if (component.escapeHandler) {
                    document.removeEventListener('keydown', component.escapeHandler);
                    component.escapeHandler = null;
                }
            }
            
            getComponent(id) {
                return this.components.get(id);
            }
            
            getAllComponents() {
                return Array.from(this.components.values());
            }
            
            getComponentsByType(type) {
                return Array.from(this.components.values()).filter(component => component.type === type);
            }
            
            hasComponent(id) {
                return this.components.has(id);
            }
            
            getComponentTypes() {
                return this.componentTypes;
            }
            
            cleanup() {
                // Trigger onUnmount hooks
                this.components.forEach(component => {
                    const hooks = this.lifecycleHooks.get(component.id);
                    if (hooks && hooks.onUnmount) {
                        hooks.onUnmount();
                    }
                });
                
                this.components.clear();
                this.lifecycleHooks.clear();
                this.componentTypes.clear();
            }
        }

        // Test the UIComponentLibrary
        function runTests() {
            const results = [];
            
            // Test 1: Button Component Management
            try {
                const eventFramework = new EventFramework();
                const uiLibrary = new UIComponentLibrary(eventFramework);
                
                // Create test button element
                const testButton = document.createElement('button');
                testButton.id = 'test-management';
                document.body.appendChild(testButton);
                
                const button = uiLibrary.createButton({
                    id: 'test-management',
                    label: 'Test Button'
                });
                
                // Test component management
                const hasComponent = uiLibrary.hasComponent('test-management');
                const retrievedComponent = uiLibrary.getComponent('test-management');
                const allComponents = uiLibrary.getAllComponents();
                const buttonComponents = uiLibrary.getComponentsByType('button');
                const componentTypes = uiLibrary.getComponentTypes();
                
                // Debug logging
                console.log('Component Management Test Debug:');
                console.log('Button created:', !!button);
                console.log('Button element:', button?.element);
                console.log('Component types size:', componentTypes.size);
                console.log('Component types:', Array.from(componentTypes));
                console.log('All components length:', allComponents.length);
                console.log('Button components length:', buttonComponents.length);
                
                const buttonTestPassed = hasComponent && retrievedComponent === button && allComponents.length === 1 && buttonComponents.length === 1 && componentTypes.size === 1 && componentTypes.has('button');
                
                // Cleanup
                document.body.removeChild(testButton);
                uiLibrary.cleanup();
                eventFramework.cleanup();
                
                results.push({
                    test: 'Button Component Management',
                    passed: buttonTestPassed,
                    details: `has: ${hasComponent}, retrieved: ${!!retrievedComponent}, all: ${allComponents.length}, buttons: ${buttonComponents.length}, types: ${componentTypes.size} (expected: 1)`
                });
            } catch (error) {
                console.error('Error in Button Component Management Test:', error);
                results.push({
                    test: 'Button Component Management',
                    passed: false,
                    details: `Error: ${error.message}`
                });
            }
            
            // Test 2: Modal State Management
            try {
                const eventFramework = new EventFramework();
                const uiLibrary = new UIComponentLibrary(eventFramework);
                
                // Create test modal element with proper structure
                const testModal = document.createElement('div');
                testModal.id = 'test-modal-state';
                
                // Add modal structure with title and content elements
                const modalHeader = document.createElement('div');
                modalHeader.className = 'modal-header';
                const titleElement = document.createElement('h2');
                titleElement.setAttribute('data-modal-title', '');
                titleElement.textContent = 'Test Modal';
                modalHeader.appendChild(titleElement);
                testModal.appendChild(modalHeader);
                
                const modalBody = document.createElement('div');
                modalBody.className = 'modal-body';
                const contentElement = document.createElement('div');
                contentElement.setAttribute('data-modal-content', '');
                modalBody.appendChild(contentElement);
                testModal.appendChild(modalBody);
                
                document.body.appendChild(testModal);
                
                const modal = uiLibrary.createModal({
                    id: 'test-modal-state',
                    title: 'Test Modal'
                });
                
                // Test modal state management
                const initialVisible = modal.state.isVisible;
                modal.methods.open();
                const isOpen = modal.state.isVisible;
                
                modal.methods.close();
                const isClosed = !modal.state.isVisible;
                
                modal.methods.setTitle('Updated Title');
                const newTitle = modal.methods.getTitle();
                
                // Debug logging
                console.log('Modal State Management Test Debug:');
                console.log('Modal created:', !!modal);
                console.log('Modal element:', modal?.element);
                console.log('Initial visible:', initialVisible);
                console.log('Is open:', isOpen);
                console.log('Is closed:', isClosed);
                console.log('New title:', newTitle);
                console.log('Expected title:', 'Updated Title');
                
                const modalTestPassed = !initialVisible && isOpen && isClosed && newTitle === 'Updated Title';
                
                // Cleanup
                document.body.removeChild(testModal);
                uiLibrary.cleanup();
                eventFramework.cleanup();
                
                results.push({
                    test: 'Modal State Management',
                    passed: modalTestPassed,
                    details: `initial: ${initialVisible}, open: ${isOpen}, closed: ${isClosed}, title: ${newTitle}`
                });
            } catch (error) {
                console.error('Error in Modal State Management Test:', error);
                results.push({
                    test: 'Modal State Management',
                    passed: false,
                    details: `Error: ${error.message}`
                });
            }
            
            // Display results
            const resultsDiv = document.getElementById('test-results');
            results.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.style.padding = '10px';
                resultDiv.style.margin = '5px';
                resultDiv.style.border = '1px solid #ccc';
                resultDiv.style.backgroundColor = result.passed ? '#d4edda' : '#f8d7da';
                resultDiv.innerHTML = `
                    <strong>${result.test}:</strong> ${result.passed ? 'PASSED' : 'FAILED'}<br>
                    <small>${result.details}</small>
                `;
                resultsDiv.appendChild(resultDiv);
            });
        }

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>
